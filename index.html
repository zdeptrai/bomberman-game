<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ Ch∆°i ƒê·∫∑t Bom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            background-color: #1a202c;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 1000px;
            width: 100%;
        }
        
        #game-board-wrapper {
            position: relative;
        }

        #game-board {
            display: grid;
            border: 2px solid #a0aec0;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            background-color: #2d3748;
            border-radius: 8px;
        }

        .cell {
            width: 40px;
            height: 40px;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .cell.wall {
            background: #4a5568;
            border-color: #2d3748;
            background: linear-gradient(135deg, #4a5568, #2d3748);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        .cell.destructible {
            background: #a78bfa;
            border: 1px solid #7c3aed;
            background: linear-gradient(135deg, #a78bfa, #7c3aed);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        .cell.powerup {
            background-color: #48bb78;
            position: relative;
            animation: pulse 1s infinite;
        }
        .cell.powerup.speed::before {
            content: '‚ö°Ô∏è';
            font-size: 24px;
        }
        .cell.powerup.blast::before {
            content: 'üí•';
            font-size: 24px;
        }
        .cell.explosion {
            background-color: transparent;
            animation: explode 0.5s ease-in-out;
            border: none;
            overflow: hidden;
        }
        .cell.explosion::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f56565;
            animation: explosion-wave 0.5s forwards;
            opacity: 0.8;
            z-index: 10;
        }
        @keyframes explosion-wave {
            0% { transform: scale(0.5); opacity: 0.8; border-radius: 50%; }
            50% { transform: scale(1.5); opacity: 0.5; border-radius: 20%; }
            100% { transform: scale(2); opacity: 0; border-radius: 10%; }
        }
        .cell.player-1 {
            border: 2px solid #4299e1;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            z-index: 20;
        }
        .cell.player-1::after {
            content: 'ü§ñ';
            animation: blink 2s infinite;
        }
        .cell.player-2 {
            border: 2px solid #ed8936;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            z-index: 20;
        }
        .cell.player-2::after {
            content: 'üëæ';
            animation: blink 2s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .cell.bomb {
            background-color: #e53e3e;
            border: 2px solid #c53030;
            position: relative;
            border-radius: 50%;
            animation: bomb-timer 1s infinite;
            z-index: 15;
        }
        
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.7);
            z-index: 100;
            text-align: center;
            border: 2px solid #4a5568;
            display: none;
        }
        .message-box button {
            margin-top: 1rem;
            font-weight: bold;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.9); }
            50% { transform: scale(1.1); }
            100% { transform: scale(0.9); }
        }
        @keyframes bomb-timer {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        #game-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col items-center p-4">
    <div class="container bg-gray-800 p-8 rounded-lg shadow-xl">
        <h1 class="text-4xl font-bold mb-4 text-purple-400">Tr√≤ Ch∆°i ƒê·∫∑t Bom</h1>
        <div id="start-screen" class="flex flex-col items-center">
            <h2 class="text-2xl font-bold mb-4">Ch√†o m·ª´ng!</h2>
            <p class="mb-4 text-center">ƒê√¢y l√† phi√™n b·∫£n ch∆°i 2 ng∆∞·ªùi tr√™n c√πng m·ªôt m√°y t√≠nh.</p>
            <button id="start-game-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-full text-lg transition-colors duration-200">B·∫Øt ƒë·∫ßu</button>
            <div class="mt-8 text-left">
                <h3 class="text-xl font-bold mb-2">C√°ch ch∆°i:</h3>
                <p class="text-blue-400 font-bold">Ng∆∞·ªùi ch∆°i 1 (ü§ñ)</p>
                <ul class="list-disc list-inside mb-4">
                    <li>Di chuy·ªÉn: W, A, S, D</li>
                    <li>ƒê·∫∑t bom: Ph√≠m c√°ch</li>
                </ul>
                <p class="text-yellow-400 font-bold">Ng∆∞·ªùi ch∆°i 2 (üëæ)</p>
                <ul class="list-disc list-inside mb-4">
                    <li>Di chuy·ªÉn: Ph√≠m M≈©i t√™n</li>
                    <li>ƒê·∫∑t bom: Ph√≠m Enter</li>
                </ul>
            </div>
        </div>
        
        <div id="game-container" class="hidden flex flex-col items-center mt-8 w-full">
            <h2 id="gameStatus" class="text-2xl font-bold mb-4 text-center"></h2>
            
            <div class="w-full flex justify-between items-start mb-4">
                <!-- Th√¥ng tin ng∆∞·ªùi ch∆°i 1 -->
                <div id="player1Status" class="flex-1 p-3 bg-gray-700 rounded-lg mr-2">
                    <p class="font-bold text-lg text-blue-400">Ng∆∞·ªùi ch∆°i 1 (ü§ñ)</p>
                    <p class="text-sm">T·ªëc ƒë·ªô: <span id="player1-speed">1</span></p>
                    <p class="text-sm">Ph·∫°m vi n·ªï: <span id="player1-blast">1</span></p>
                </div>
                
                <!-- Th√¥ng tin ng∆∞·ªùi ch∆°i 2 -->
                <div id="player2Status" class="flex-1 p-3 bg-gray-700 rounded-lg ml-2">
                    <p class="font-bold text-lg text-yellow-400">Ng∆∞·ªùi ch∆°i 2 (üëæ)</p>
                    <p class="text-sm">T·ªëc ƒë·ªô: <span id="player2-speed">1</span></p>
                    <p class="text-sm">Ph·∫°m vi n·ªï: <span id="player2-blast">1</span></p>
                </div>
            </div>

            <div id="game-board-wrapper" class="flex justify-center items-center">
                <div id="game-board"></div>
            </div>
        </div>

        <!-- H·ªôp th√¥ng b√°o t√πy ch·ªânh -->
        <div id="messageBox" class="message-box hidden">
            <h2 id="messageTitle" class="text-3xl font-bold text-purple-400"></h2>
            <p id="messageText" class="mt-2 text-lg"></p>
            <button id="messageButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full">Ch∆°i l·∫°i</button>
        </div>
    </div>
    
    <script>
        // K√≠ch th∆∞·ªõc b·∫£n ƒë·ªì
        const MAP_SIZE = 15;
        const CELL_SIZE = 40;
        
        // Lo·∫°i √¥ tr√™n b·∫£n ƒë·ªì
        const WALL = 'W';
        const DESTRUCTIBLE = 'D';
        const EMPTY = 'E';
        const POWERUP_SPEED = 'PS';
        const POWERUP_BLAST = 'PB';
        const BOMB = 'B';
        const EXPLOSION = 'X';

        // Bi·∫øn tr·∫°ng th√°i tr√≤ ch∆°i
        let gameData = {};
        let isGameRunning = false;
        
        let bombSynth;
        let explosionSynth;

        const maps = [
            // B·∫£n ƒë·ªì 1
            [
                'W W W W W W W W W W W W W W W',
                'W E D D D D D D D D D D D D W',
                'W D W D W D W D W D W D W D W',
                'W D D D D D D D D D D D D D W',
                'W D W D W D W D W D W D W D W',
                'W D D D D D D D D D D D D D W',
                'W D W D W D W D W D W D W D W',
                'W D D D D D D D D D D D D D W',
                'W D W D W D W D W D W D W D W',
                'W D D D D D D D D D D D D D W',
                'W D W D W D W D W D W D W D W',
                'W D D D D D D D D D D D D D W',
                'W D W D W D W D W D W D W D W',
                'W D D D D D D D D D D D D D W',
                'W W W W W W W W W W W W W W W',
            ].map(row => row.split(' ')),
            // B·∫£n ƒë·ªì 2
            [
                'W W W W W W W W W W W W W W W',
                'W E D D W D D W D D W D D E W',
                'W D W D W D W D W D W D W D W',
                'W D D D D D D D D D D D D D W',
                'W W W D W D W D W D W D W W W',
                'W D D D D D D D D D D D D D W',
                'W D W D W W W D W D W D W D W',
                'W D D D D D D D D D D D D D W',
                'W D W D W D W D W D W D W D W',
                'W D D D D D D D D D D D D D W',
                'W W W D W D W D W D W D W W W',
                'W D D D D D D D D D D D D D W',
                'W D W D W D W D W D W D W D W',
                'W E D D W D D W D D W D D E W',
                'W W W W W W W W W W W W W W W',
            ].map(row => row.split(' ')),
        ];

        // V·ªã tr√≠ b·∫Øt ƒë·∫ßu c·ªßa ng∆∞·ªùi ch∆°i
        const playerStartPositions = {
            1: { x: 1, y: 1 },
            2: { x: MAP_SIZE - 2, y: MAP_SIZE - 2 }
        };

        // H√†m t·∫°o b·∫£ng game
        function createGameBoard() {
            const gameBoard = document.getElementById('game-board');
            gameBoard.innerHTML = '';
            gameBoard.style.gridTemplateColumns = `repeat(${MAP_SIZE}, ${CELL_SIZE}px)`;

            for (let y = 0; y < MAP_SIZE; y++) {
                for (let x = 0; x < MAP_SIZE; x++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    gameBoard.appendChild(cell);
                }
            }
        }

        // C·∫≠p nh·∫≠t giao di·ªán d·ª±a tr√™n d·ªØ li·ªáu game
        function updateUI() {
            const { map, players, turn, gameState } = gameData;
            
            const gameStatusEl = document.getElementById('gameStatus');
            const player1SpeedEl = document.getElementById('player1-speed');
            const player1BlastEl = document.getElementById('player1-blast');
            const player2SpeedEl = document.getElementById('player2-speed');
            const player2BlastEl = document.getElementById('player2-blast');
            
            if (gameState === 'playing') {
                gameStatusEl.textContent = `L∆∞·ª£t c·ªßa ng∆∞·ªùi ch∆°i ${turn}`;
            } else if (gameState === 'win') {
                const winner = gameData.winner;
                showMessage(`Ng∆∞·ªùi ch∆°i ${winner} ƒë√£ th·∫Øng!`, 'Ch√∫c m·ª´ng b·∫°n ƒë√£ ƒë√°nh b·∫°i ƒë·ªëi th·ªß!');
                return;
            } else if (gameState === 'draw') {
                showMessage('H√≤a!', 'Kh√¥ng c√≤n ai chi·∫øn th·∫Øng.');
                return;
            }
            
            if (players[1]) {
                player1SpeedEl.textContent = players[1].speed;
                player1BlastEl.textContent = players[1].blastRange;
            } else {
                player1SpeedEl.textContent = 'ƒê√£ thua';
                player1BlastEl.textContent = 'ƒê√£ thua';
            }
            
            if (players[2]) {
                player2SpeedEl.textContent = players[2].speed;
                player2BlastEl.textContent = players[2].blastRange;
            } else {
                player2SpeedEl.textContent = 'ƒê√£ thua';
                player2BlastEl.textContent = 'ƒê√£ thua';
            }

            // V·∫Ω l·∫°i b·∫£n ƒë·ªì
            for (let y = 0; y < MAP_SIZE; y++) {
                for (let x = 0; x < MAP_SIZE; x++) {
                    const cell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
                    cell.className = 'cell';

                    const cellType = map[y][x];
                    if (cellType === WALL) {
                        cell.classList.add('wall');
                    } else if (cellType === DESTRUCTIBLE) {
                        cell.classList.add('destructible');
                    } else if (cellType === POWERUP_SPEED) {
                        cell.classList.add('powerup', 'speed');
                    } else if (cellType === POWERUP_BLAST) {
                        cell.classList.add('powerup', 'blast');
                    } else if (cellType === BOMB) {
                        cell.classList.add('bomb');
                    } else if (cellType === EXPLOSION) {
                        cell.classList.add('explosion');
                    }

                    // V·∫Ω ng∆∞·ªùi ch∆°i
                    if (players['1'] && players['1'].x === x && players['1'].y === y) {
                        cell.classList.add('player-1');
                    }
                    if (players['2'] && players['2'].x === x && players['2'].y === y) {
                        cell.classList.add('player-2');
                    }
                }
            }
        }

        // X·ª≠ l√Ω c√°c ph√≠m di chuy·ªÉn v√† ƒë·∫∑t bom
        async function handleKeydown(e) {
            console.log("Ph√≠m ƒë∆∞·ª£c nh·∫•n:", e.key);
            console.log("Tr·∫°ng th√°i game:", isGameRunning);

            if (!isGameRunning) {
                console.log("Tr√≤ ch∆°i ch∆∞a b·∫Øt ƒë·∫ßu, b·ªè qua ph√≠m nh·∫•n.");
                return;
            }

            const players = gameData.players;
            let updated = false;

            // Ng∆∞·ªùi ch∆°i 1
            if (players[1] && gameData.turn === 1) {
                let newPos = { ...players[1] };
                let moveSpeed = players[1].speed || 1;

                switch (e.key) {
                    case 'w': case 'W': newPos.y -= moveSpeed; updated = true; break;
                    case 'a': case 'A': newPos.x -= moveSpeed; updated = true; break;
                    case 's': case 'S': newPos.y += moveSpeed; updated = true; break;
                    case 'd': case 'D': newPos.x += moveSpeed; updated = true; break;
                    case ' ': placeBomb(players[1].x, players[1].y, 1); return;
                }

                if (updated && isValidMove(newPos)) {
                    gameData.players[1].x = newPos.x;
                    gameData.players[1].y = newPos.y;
                    checkPowerup(newPos, 1);
                    gameData.turn = 2; // Chuy·ªÉn l∆∞·ª£t
                    updateUI();
                }
            }
            
            // Ng∆∞·ªùi ch∆°i 2
            if (players[2] && gameData.turn === 2) {
                let newPos = { ...players[2] };
                let moveSpeed = players[2].speed || 1;

                switch (e.key) {
                    case 'ArrowUp': newPos.y -= moveSpeed; updated = true; break;
                    case 'ArrowDown': newPos.y += moveSpeed; updated = true; break;
                    case 'ArrowLeft': newPos.x -= moveSpeed; updated = true; break;
                    case 'ArrowRight': newPos.x += moveSpeed; updated = true; break;
                    case 'Enter': placeBomb(players[2].x, players[2].y, 2); return;
                }

                if (updated && isValidMove(newPos)) {
                    gameData.players[2].x = newPos.x;
                    gameData.players[2].y = newPos.y;
                    checkPowerup(newPos, 2);
                    gameData.turn = 1; // Chuy·ªÉn l∆∞·ª£t
                    updateUI();
                }
            }
        }
        
        // Ki·ªÉm tra di chuy·ªÉn h·ª£p l·ªá
        function isValidMove(newPos) {
            if (newPos.x < 0 || newPos.x >= MAP_SIZE || newPos.y < 0 || newPos.y >= MAP_SIZE) {
                return false;
            }
            const cellType = gameData.map[newPos.y][newPos.x];
            return cellType === EMPTY || cellType.startsWith('P');
        }

        // Ki·ªÉm tra v√† nh·∫∑t power-up
        function checkPowerup(pos, playerNumber) {
            const cellType = gameData.map[pos.y][pos.x];
            if (cellType === EMPTY || !cellType.startsWith('P')) return;

            gameData.map[pos.y][pos.x] = EMPTY;
            const player = gameData.players[playerNumber];
            
            if (cellType === POWERUP_SPEED) {
                player.speed = (player.speed || 1) + 1;
            } else if (cellType === POWERUP_BLAST) {
                player.blastRange = (player.blastRange || 1) + 1;
            }
        }

        // ƒê·∫∑t bom
        function placeBomb(x, y, playerNumber) {
            if (gameData.map[y][x] === EMPTY) {
                if (bombSynth) bombSynth.triggerAttackRelease('C4', '8n');
                gameData.map[y][x] = BOMB;
                updateUI();
                
                // H·∫πn gi·ªù bom n·ªï
                setTimeout(() => {
                    explodeBomb(x, y, playerNumber);
                }, 2000);
            }
        }
        
        // Bom n·ªï
        function explodeBomb(bombX, bombY, playerNumber) {
            const { map, players } = gameData;
            const blastRange = players[playerNumber].blastRange || 1;
            
            if (explosionSynth) explosionSynth.triggerAttackRelease('8n');
            
            const affectedCells = [{ x: bombX, y: bombY }];
            map[bombY][bombX] = EXPLOSION;
            
            const directions = [{dx: 1, dy: 0}, {dx: -1, dy: 0}, {dx: 0, dy: 1}, {dx: 0, dy: -1}];
            directions.forEach(dir => {
                for (let i = 1; i <= blastRange; i++) {
                    const newX = bombX + dir.dx * i;
                    const newY = bombY + dir.dy * i;
                    
                    if (newX >= 0 && newX < MAP_SIZE && newY >= 0 && newY < MAP_SIZE) {
                        const cellType = map[newY][newX];
                        if (cellType === WALL) break;
                        
                        if (cellType === DESTRUCTIBLE) {
                            map[newY][newX] = Math.random() < 0.3 ? (Math.random() < 0.5 ? POWERUP_SPEED : POWERUP_BLAST) : EMPTY;
                            affectedCells.push({x: newX, y: newY});
                            break;
                        }
                        
                        map[newY][newX] = EXPLOSION;
                        affectedCells.push({x: newX, y: newY});
                    }
                }
            });

            updateUI();

            // Ki·ªÉm tra ng∆∞·ªùi ch∆°i b·ªã d√≠nh bom
            const playersKilled = Object.keys(players).filter(pNum => 
                affectedCells.some(cell => players[pNum] && cell.x === players[pNum].x && cell.y === players[pNum].y)
            );
            
            // X√≥a v√πng n·ªï v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i ng∆∞·ªùi ch∆°i
            setTimeout(() => {
                affectedCells.forEach(cell => {
                    map[cell.y][cell.x] = EMPTY;
                });
                
                playersKilled.forEach(pNum => {
                    delete players[pNum];
                });
                
                checkGameOver();
                updateUI();
            }, 500);
        }
        
        // Ki·ªÉm tra ƒëi·ªÅu ki·ªán th·∫Øng/thua
        function checkGameOver() {
            const livingPlayers = Object.keys(gameData.players);
            if (livingPlayers.length <= 1) {
                if (livingPlayers.length === 1) {
                    gameData.gameState = 'win';
                    gameData.winner = parseInt(livingPlayers[0]);
                } else {
                    gameData.gameState = 'draw';
                }
                isGameRunning = false;
            }
        }
        
        // Hi·ªÉn th·ªã th√¥ng b√°o
        function showMessage(title, text) {
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageText').textContent = text;
            document.getElementById('messageBox').classList.remove('hidden');
        }

        // Kh·ªüi ƒë·ªông tr√≤ ch∆°i
        function startGame() {
            // Kh·ªüi t·∫°o √¢m thanh sau khi ng∆∞·ªùi d√πng t∆∞∆°ng t√°c
            bombSynth = new Tone.MembraneSynth().toDestination();
            explosionSynth = new Tone.NoiseSynth({
                noise: { type: 'pink' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.05 }
            }).toDestination();
            console.log("ƒê√£ kh·ªüi t·∫°o √¢m thanh.");

            const randomMap = maps[Math.floor(Math.random() * maps.length)];

            gameData = {
                map: JSON.parse(JSON.stringify(randomMap)),
                players: {
                    1: { ...playerStartPositions[1], speed: 1, blastRange: 1 },
                    2: { ...playerStartPositions[2], speed: 1, blastRange: 1 }
                },
                turn: 1,
                gameState: 'playing'
            };
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            
            createGameBoard();
            isGameRunning = true;
            console.log("Tr√≤ ch∆°i ƒë√£ b·∫Øt ƒë·∫ßu. isGameRunning =", isGameRunning);
            updateUI();
        }

        // X·ª≠ l√Ω n√∫t ch∆°i l·∫°i trong h·ªôp th√¥ng b√°o
        document.getElementById('messageButton').addEventListener('click', () => {
             location.reload();
        });
        
        document.getElementById('start-game-btn').addEventListener('click', () => {
            // B·∫Øt ƒë·∫ßu context √¢m thanh
            Tone.start();
            startGame();
        });
        
        document.addEventListener('keydown', handleKeydown);
    </script>
</body>
</html>
